{% extends 'base.html' %}
{% load static %}

{% block title %}{{ sweet.name }} | Sweet Spot{% endblock %}

{% block content %}
<div class="sweet-detail-wrapper">
    <div class="sweet-image-container">
        <img src="{{ sweet.image.url }}" alt="{{ sweet.name }}">
    </div>
    <div class="sweet-info-container">
        <h2>{{ sweet.name }}</h2>
        <p class="description">{{ sweet.description }}</p>

        <div class="price-display" id="priceDisplay"></div>

        <form id="add-to-cart-form" action="{% url 'api_add_to_cart' sweet.id %}" method="POST">
            {% csrf_token %}
            <div class="selectors">
                <div>
                    <label class="selector-label" for="w250">WEIGHT</label>
                    <div class="weight-selector">
                        <input type="radio" id="w250" name="weight_multiplier" value="1" checked>
                        <label for="w250">250gm</label>
                        
                        <input type="radio" id="w500" name="weight_multiplier" value="2">
                        <label for="w500">500gm</label>
                        
                        <input type="radio" id="w1kg" name="weight_multiplier" value="4">
                        <label for="w1kg">1kg</label>
                    </div>
                </div>

                <div>
                    <label class="selector-label" for="qtyInput">QUANTITY</label>
                    <div class="qty-selector">
                        <button type="button" class="qty-btn" id="qtyMinus">-</button>
                        <input id="qtyInput" type="number" value="1" min="1" name="quantity" readonly>
                        <button type="button" class="qty-btn" id="qtyPlus">+</button>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="orderBtn">ADD TO CART</button>
        </form>

        {{ sweet.id|json_script:"sweet-id" }}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const basePrice = parseFloat("{{ sweet.price }}");
    const sweetId = JSON.parse(document.getElementById('sweet-id').textContent);

    const weightSelector = document.querySelector('.weight-selector'); 
    const qtyInput = document.getElementById('qtyInput');
    const priceDisplay = document.getElementById('priceDisplay');
    const qtyPlus = document.getElementById('qtyPlus');
    const qtyMinus = document.getElementById('qtyMinus');
    const cartForm = document.getElementById('add-to-cart-form');

    function updatePrice() {
        const weightFactor = parseFloat(document.querySelector('input[name="weight_multiplier"]:checked').value);
        const qty = parseInt(qtyInput.value);
        const newPrice = basePrice * weightFactor * qty;
        priceDisplay.style.opacity = 0;
        setTimeout(() => {
            priceDisplay.textContent = "₹" + newPrice.toFixed(2);
            priceDisplay.style.opacity = 1;
        }, 150);
    }

    qtyPlus.addEventListener('click', () => {
        qtyInput.value = parseInt(qtyInput.value) + 1;
        updatePrice();
    });

    qtyMinus.addEventListener('click', () => {
        const currentQty = parseInt(qtyInput.value);
        if (currentQty > 1) {
            qtyInput.value = currentQty - 1;
            updatePrice();
        }
    });

    weightSelector.addEventListener('change', updatePrice);
    updatePrice(); // initialize on page load

    // ✅ CALL GLOBAL AJAX FUNCTION
    cartForm.addEventListener('submit', (event) => {
        event.preventDefault(); // prevent normal form submission
        ajaxAddToCart(cartForm, sweetId); // call the function from base.html
    });
});
</script>
{% endblock %}
